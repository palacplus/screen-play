name: Semantic Commit

on:
  pull_request:
    types:
      - labeled

jobs:
  add-semantic-commit:
    if: contains(github.event.label.name, 'major') || contains(github.event.label.name, 'minor') || contains(github.event.label.name, 'patch')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Determine commit message based on label
        id: commit-message
        run: |
          LABEL="${{ github.event.label.name }}"
          case "$LABEL" in
            "major")
              echo message="BREAKING: Prepare for major release" >> $GITHUB_OUTPUT
              echo "‚úÖ Added BREAKING commit for major version bump"
              ;;
            "minor")
              echo message="feature: Prepare for minor release" >> $GITHUB_OUTPUT
              echo "‚úÖ Added feat commit for minor version bump"
              ;;
            "patch")
              echo message="bugfix: Prepare for patch release" >> $GITHUB_OUTPUT
              echo "‚úÖ Added bugfix commit for patch version bump"
              ;;
          esac

      - name: Commit and push empty commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit --allow-empty -m "${{ steps.commit-message.outputs.message }}"
          git push

      - name: Add confirmation comment
        uses: actions/github-script@v6
        with:
          script: |
            const label = '${{ github.event.label.name }}';
            const keywords = {
              'major': 'BREAKING',
              'minor': 'feature', 
              'patch': 'bugfix'
            };
            
            const keyword = keywords[label];            
            let message;
            message = `üè∑Ô∏è **${label.toUpperCase()} label applied**
            
            ü§ñ Added empty commit with "${keyword}" keyword to ensure proper version bumping.
            
            The semantic versioning action will now correctly identify this as a **${label}** version bump when this PR is merged.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
